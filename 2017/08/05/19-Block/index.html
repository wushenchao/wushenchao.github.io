<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOS,">










<meta name="description" content="一、概述Block是C语言的扩充功能。可以用一句话来表示Block: 带有自动变量的匿名函数。 匿名函数：没有函数名的函数，一对  {}  包裹的内容是匿名函数的作用域。 自动变量：栈上声明的变量(不是静态变量和全局变量)，是不可以在这个栈内声明的匿名函数中使用，但在Block中却可以。 虽然使用Block不用声明类，但是Block提供了类似OC的类一样可以通过成员变量来保存作用域外变量值的方法，">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="Block详解">
<meta property="og:url" content="http://yoursite.com/2017/08/05/19-Block/index.html">
<meta property="og:site_name" content="不知是哪个号">
<meta property="og:description" content="一、概述Block是C语言的扩充功能。可以用一句话来表示Block: 带有自动变量的匿名函数。 匿名函数：没有函数名的函数，一对  {}  包裹的内容是匿名函数的作用域。 自动变量：栈上声明的变量(不是静态变量和全局变量)，是不可以在这个栈内声明的匿名函数中使用，但在Block中却可以。 虽然使用Block不用声明类，但是Block提供了类似OC的类一样可以通过成员变量来保存作用域外变量值的方法，">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/images/20/20-1.png">
<meta property="og:image" content="http://yoursite.com/images/20/20-4.png">
<meta property="og:image" content="http://yoursite.com/images/20/20-5.png">
<meta property="og:image" content="http://yoursite.com/images/20/20-6.png">
<meta property="og:image" content="http://yoursite.com/images/20/20-2.png">
<meta property="og:image" content="http://yoursite.com/images/20/20-3.png">
<meta property="og:updated_time" content="2019-08-08T08:35:52.069Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Block详解">
<meta name="twitter:description" content="一、概述Block是C语言的扩充功能。可以用一句话来表示Block: 带有自动变量的匿名函数。 匿名函数：没有函数名的函数，一对  {}  包裹的内容是匿名函数的作用域。 自动变量：栈上声明的变量(不是静态变量和全局变量)，是不可以在这个栈内声明的匿名函数中使用，但在Block中却可以。 虽然使用Block不用声明类，但是Block提供了类似OC的类一样可以通过成员变量来保存作用域外变量值的方法，">
<meta name="twitter:image" content="http://yoursite.com/images/20/20-1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/08/05/19-Block/">





  <title>Block详解 | 不知是哪个号</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">不知是哪个号</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">It's never too old to learn.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/05/19-Block/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content>
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不知是哪个号">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Block详解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-05T00:00:00+08:00">
                2017-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/08/05/19-Block/" class="leancloud_visitors" data-flag-title="Block详解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  2.2k words
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  9 minutes
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>Block是C语言的扩充功能。可以用一句话来表示Block: 带有自动变量的匿名函数。</p>
<p>匿名函数：没有函数名的函数，一对  <em>{}</em>  包裹的内容是匿名函数的作用域。</p>
<p>自动变量：栈上声明的变量(不是静态变量和全局变量)，是不可以在这个栈内声明的匿名函数中使用，但在Block中却可以。</p>
<p>虽然使用Block不用声明类，但是Block提供了类似OC的类一样可以通过成员变量来保存作用域外变量值的方法，那些在Block的一对 <em>{}</em> 里使用到但却是在 <em>{}</em> 作用域以外声明的变量，就是Block截获的自动变量。</p>
<p>关于block的语法，请戳这里→ <a href="fuckingblocksyntax.com">block的语法</a></p>
<a id="more"></a>
<h2 id="二、Block捕获变量"><a href="#二、Block捕获变量" class="headerlink" title="二、Block捕获变量"></a>二、Block捕获变量</h2><p>OC代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int globalVar = 15;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    int localVar = 10;</span><br><span class="line">    int localVar1 = 10;</span><br><span class="line">    __block int blockLocalVar = 20;</span><br><span class="line">    __block int blockLocalVar1 = 20;</span><br><span class="line">    static int staticVar = 30;</span><br><span class="line">    static int staticVar1 = 30;</span><br><span class="line">    void(^firstBlock)(int) = ^(int incomVar) &#123;</span><br><span class="line">        int tmp = globalVar + localVar + staticVar + blockLocalVar + incomVar;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    firstBlock(3);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过clang命令（clang -rewrite-objc main.m）可将上述 main.m(OC) 文件转为 main.cpp（C++）文件(下同), 主要代码如下所示</p>
<p>注：如果使用该命令报错：’UIKit/UIKit.h’ file not found.<br>使用如下命令解决:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -x objective-c -rewrite-objc -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk xxx.m</span><br></pre></td></tr></table></figure>
<p>更多请参考: <a href="https://www.jianshu.com/p/43a09727eb2c" target="_blank" rel="noopener">《Objective-C编译成C++代码报错》</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">// 全局变量</span><br><span class="line">int globalVar = 15;</span><br><span class="line"></span><br><span class="line">// __block 修饰的变量转换成结构体</span><br><span class="line">struct __Block_byref_blockLocalVar_0 &#123;</span><br><span class="line">  	void *__isa;</span><br><span class="line">	__Block_byref_blockLocalVar_0 *__forwarding;</span><br><span class="line"> 	int __flags;</span><br><span class="line"> 	int __size;</span><br><span class="line"> 	int blockLocalVar;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct __main_block_impl_0 &#123;</span><br><span class="line">  	struct __block_impl impl;</span><br><span class="line">  	struct __main_block_desc_0* Desc;</span><br><span class="line">  	int localVar;</span><br><span class="line">  	int *staticVar;</span><br><span class="line">  	__Block_byref_blockLocalVar_0 *blockLocalVar; // by ref</span><br><span class="line">  	__main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _localVar, int *_staticVar, __Block_byref_blockLocalVar_0 *_blockLocalVar, int flags=0) : localVar(_localVar), staticVar(_staticVar), 	blockLocalVar(_blockLocalVar-&gt;__forwarding) &#123;</span><br><span class="line">    	impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    	impl.Flags = flags;</span><br><span class="line">    	impl.FuncPtr = fp;</span><br><span class="line">    	Desc = desc;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// block方法实现</span><br><span class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself, int incomVar) &#123;</span><br><span class="line"> 	 __Block_byref_blockLocalVar_0 *blockLocalVar = __cself-&gt;blockLocalVar; // bound by ref</span><br><span class="line">  	int localVar = __cself-&gt;localVar; // bound by copy</span><br><span class="line">  	int *staticVar = __cself-&gt;staticVar; // bound by copy</span><br><span class="line">  	int tmp = globalVar + localVar + (*staticVar) + (blockLocalVar-&gt;__forwarding-&gt;blockLocalVar) + incomVar;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">	// block内使用</span><br><span class="line">    int localVar = 10;</span><br><span class="line">    // block内未使用</span><br><span class="line">    int localVar1 = 10;</span><br><span class="line">    // block内使用</span><br><span class="line">    __attribute__((__blocks__(byref))) __Block_byref_blockLocalVar_0 blockLocalVar = &#123;(void*)0,(__Block_byref_blockLocalVar_0 *)&amp;blockLocalVar, 0, sizeof(__Block_byref_blockLocalVar_0), 20&#125;;</span><br><span class="line">    // block内未使用</span><br><span class="line">    __attribute__((__blocks__(byref))) __Block_byref_blockLocalVar1_1 blockLocalVar1 = &#123;(void*)0,(__Block_byref_blockLocalVar1_1 *)&amp;blockLocalVar1, 0, sizeof(__Block_byref_blockLocalVar1_1), 20&#125;;</span><br><span class="line">    static int staticVar = 30;</span><br><span class="line">    static int staticVar1 = 30;</span><br><span class="line">    // 从第三个参数开始: localVar变量的值，staticVar指针，blockLocalVar指针</span><br><span class="line">    void(*firstBlock)(int) = ((void (*)(int))&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, localVar, &amp;staticVar, (__Block_byref_blockLocalVar_0 *)&amp;blockLocalVar, 570425344));</span><br><span class="line">	// block 调用</span><br><span class="line">    ((void (*)(__block_impl *, int))((__block_impl *)firstBlock)-&gt;FuncPtr)((__block_impl *)firstBlock, 3);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>block变量实际上就是一个指向__main_block_impl_0的指针，结构体从第三个元素开始分别是传入局部变量的值和变量指针。</p>
</li>
<li><p>block的方法实际上是指向结构体的指针firstBlock访问FuncPtr元素,在定义block时为FuncPtr元素传进去的__main_block_func_0方法，而tmp的赋值正是定义block时为结构体传进去的局部变量的值和变量的指针。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1. 对于局部变量（localVar）block将localVar直接复制到数据结构中来实现访问。并且block只截获</span><br><span class="line">内部使用的变量,不使用则不截获（因为截获的自动变量会存储于block的结构体的内部,会导致block体积</span><br><span class="line">变大）。所以在调用block之后对局部变量进行修改并不会影响block内部的值,同时在block内部localVar</span><br><span class="line">变量也是不可修改的。</span><br><span class="line"></span><br><span class="line">2. 对于全局变量（globalVar）占用的内存只有一份,供所有的函数共同调用,block在定义时并未将全局变</span><br><span class="line">量的值或者指针传给block所指向的结构体,因此在调用block之前对全局变量进行修改会直接影响到block内</span><br><span class="line">部的值,同时在block内部也可以对globalVar变量进行修改。</span><br><span class="line"></span><br><span class="line">3. 对于static修饰的静态变量（staticVar）block在定义过程中是把静态变量的指针传给block变量所</span><br><span class="line">指向的结构体,因此在调用block之前对静态变量进行修改会影响block内部的值,同时在block内部也可以</span><br><span class="line">对该变量进行修改。</span><br><span class="line"></span><br><span class="line">4. 对于__block前缀修饰的变量(blockVar)，首先该变量会自动转换成对应的结构体(注意里面</span><br><span class="line">__forwarding)，block在定义时便是将结构体的指针(&amp;blockVar)传给block变量所指向的结构体,因此</span><br><span class="line">在调用block之前对该变量进行修改会影响block内部的值,同时在block内部也是可以对该变量进行修改的。</span><br><span class="line"></span><br><span class="line">5. 对于block接受的参数（incomVar）传值，和一般函数的参数使用相同。</span><br></pre></td></tr></table></figure>
<h2 id="三、Block的类型"><a href="#三、Block的类型" class="headerlink" title="三、Block的类型"></a>三、Block的类型</h2><h3 id="1-block的类型"><a href="#1-block的类型" class="headerlink" title="1. block的类型"></a>1. block的类型</h3><p>block中的isa指向的是该block的Class。在block runtime中，定义了6种类型分别是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_NSConcreteStackBlock   栈上创建的block</span><br><span class="line">_NSConcreteMallocBlock  堆上创建的block</span><br><span class="line">_NSConcreteGlobalBlock  作为全局变量的block</span><br><span class="line">_NSConcreteWeakBlockVariable</span><br><span class="line">_NSConcreteAutoBlock</span><br><span class="line">_NSConcreteFinalizingBlock</span><br></pre></td></tr></table></figure>
<p>其中我们能接触到的主要是前3种,在内存中分布如下图所示:</p>
<p><img src="../../../../images/20/20-1.png" alt></p>
<h3 id="2-如何确定block的存储位置"><a href="#2-如何确定block的存储位置" class="headerlink" title="2. 如何确定block的存储位置"></a>2. 如何确定block的存储位置</h3><p><img src="../../../../images/20/20-4.png" alt></p>
<p>在 ARC 环境下打印结果如下:</p>
<p><img src="../../../../images/20/20-5.png" alt></p>
<p>在 MRC 环境下打印结果如下:</p>
<p><img src="../../../../images/20/20-6.png" alt></p>
<h5 id="1-Block不捕获变量"><a href="#1-Block不捕获变量" class="headerlink" title="1. Block不捕获变量"></a>1. Block不捕获变量</h5><p>Block既不在栈中也不在堆中,ARC和MRC下都是如此。此时为全局数据区。</p>
<h5 id="2-Block捕获变量-包括局部变量和全局变量"><a href="#2-Block捕获变量-包括局部变量和全局变量" class="headerlink" title="2. Block捕获变量(包括局部变量和全局变量)"></a>2. Block捕获变量(包括局部变量和全局变量)</h5><p>MRC环境下: 访问外界变量中的Block默认存储在栈中。</p>
<p>ARC环境下: 访问外界变量中的Block默认存储在堆中。(实际上是放在栈区,然后ARC情况下自动又拷贝到堆区),自动释放。</p>
<h3 id="3-Block的copy"><a href="#3-Block的copy" class="headerlink" title="3. Block的copy"></a>3. Block的copy</h3><p><strong>ARC下,访问外界变量(局部变量和全局变量)的Block为什么要从自动从栈区拷贝到堆区呢?</strong></p>
<p>配置在栈上的Block,如果其所属的变量作用域结束,该Block就被废弃,如一般的自动变量。对于超出block作用域任需要使用block的情况，Block提供了将Block从栈上复制到堆上的方法来解决这种问题，即便Block栈作用域已结束，但被拷贝到堆上的Block仍继续存在。</p>
<p>在ARC情况下，以下几种情况栈上的Block会自动复制到堆上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 调用Block的copy方法</span><br><span class="line">2. 将Block作为函数返回值时</span><br><span class="line">3. 将Block赋值给__strong修改的变量时</span><br><span class="line">4. 向Cocoa框架含有usingBlock的方法或者GCD的API传递Block参数时</span><br></pre></td></tr></table></figure>
<p>其它情况如向方法的参数中传递Block时，需要手动调用copy方法复制Block。将block从栈上复制到堆上相当消耗CPU,所以当block设置在栈上也能够使用时,就不用复制了,因为此时的复制只是浪费CPU资源。</p>
<p>不同类型的block使用copy方法的效果如下:</p>
<table>
<thead>
<tr>
<th>block</th>
<th>副本存储位置</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>_NSConcreteGlobalBlock</td>
<td>数据区</td>
<td>什么也不做</td>
</tr>
<tr>
<td>_NSConcreteStackBlock</td>
<td>栈</td>
<td>从栈复制到堆</td>
</tr>
<tr>
<td>_NSConcreteMallocBlock</td>
<td>堆</td>
<td>引用记数增加</td>
</tr>
</tbody>
</table>
<p>这里有几个测试例子: <a href="https://www.zybuluo.com/MicroCai/note/49713" target="_blank" rel="noopener">Block小测试</a></p>
<h3 id="4-block-修饰"><a href="#4-block-修饰" class="headerlink" title="4. __block 修饰"></a>4. __block 修饰</h3><p>使用__block修饰的自动变量，会自动转变成结构体__Block_byref_blockLocalVar_0。当我们实际访问该结构体时，实际是__forwarding的指针。 </p>
<p>在进行copy复制前（在栈上），这时该结构体的__forwarding指针指向如下所示:</p>
<p><img src="../../../../images/20/20-2.png" alt></p>
<p>在copy操作完成之后,__block变量也被copy到堆上去了,这时候该结构体的__forwarding指针<br>指向如下图所示:</p>
<p><img src="../../../../images/20/20-3.png" alt></p>
<p>通过结构体中的__forwarding指针,无论是在block内部还是block外访问__block变量,也不管该变量在栈上或堆上,也都能保证访问的是同一个__block变量。</p>
<h2 id="四、Block循环引用"><a href="#四、Block循环引用" class="headerlink" title="四、Block循环引用"></a>四、Block循环引用</h2><p>block循环引用的原因:<br>一个对象有block类型的属性，从而持有这个block，如果此时block的代码块中使用到这个对象或者是对象的属性，会使block也持有该对象，导致两者互相持有，不能在做作用域结束后正常释放。</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法:"></a>解决方法:</h3><h4 id="一-ARC环境下-使用-weak-unsafe-unretained-block"><a href="#一-ARC环境下-使用-weak-unsafe-unretained-block" class="headerlink" title="一: ARC环境下: 使用__weak / __unsafe_unretained / __block"></a>一: ARC环境下: 使用__weak / __unsafe_unretained / __block</h4><h5 id="1-weak"><a href="#1-weak" class="headerlink" title="1. __weak"></a>1. __weak</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line">__weak typeof(person) weakPerson = person;</span><br><span class="line"></span><br><span class="line">person.block = ^&#123;</span><br><span class="line">    NSLog(@&quot;age is %d&quot;, weakPerson.age);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="2-unsafe-unretained"><a href="#2-unsafe-unretained" class="headerlink" title="2. __unsafe_unretained"></a>2. __unsafe_unretained</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__unsafe_unretained Person *person = [[Person alloc] init];</span><br><span class="line">person.block = ^&#123;</span><br><span class="line">    NSLog(@&quot;age is %d&quot;, weakPerson.age);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="3-block-（注意避免产生循环引用）"><a href="#3-block-（注意避免产生循环引用）" class="headerlink" title="3. __block （注意避免产生循环引用）"></a>3. __block （注意避免产生循环引用）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__block Person *person = [[Person alloc] init];</span><br><span class="line">person.block = ^&#123;</span><br><span class="line">    NSLog(@&quot;age is %d&quot;, person.age);</span><br><span class="line">    //不能省略</span><br><span class="line">    person = nil;</span><br><span class="line">&#125;;</span><br><span class="line">//必须执行该block一次，否则会产生内存泄露</span><br><span class="line">person.block();</span><br></pre></td></tr></table></figure>
<p>三种方法的比较:</p>
<p>__weak：不会产生强引用，指向的对象销毁时，会自动让指针置为nil</p>
<p>__unsafe_unretained：不会产生强引用，不安全，指向的对象销毁时，指针存储的地址值不变</p>
<p>__block：必须把引用对象置为nil，即调用该block一次</p>
<h4 id="二-MRC下-使用-block-unsafe-unretained"><a href="#二-MRC下-使用-block-unsafe-unretained" class="headerlink" title="二: MRC下: 使用__block / __unsafe_unretained"></a>二: MRC下: 使用__block / __unsafe_unretained</h4><h5 id="1-unsafe-unretained"><a href="#1-unsafe-unretained" class="headerlink" title="1. __unsafe_unretained"></a>1. __unsafe_unretained</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__unsafe_unretained Person *person = [[Person alloc] init];</span><br><span class="line">person.block = ^&#123;</span><br><span class="line">    NSLog(@&quot;age is %d&quot;, weakPerson.age);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="2-block"><a href="#2-block" class="headerlink" title="2. __block"></a>2. __block</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">__block Person *person = [[Person alloc] init];</span><br><span class="line">person.block = ^&#123;</span><br><span class="line">    NSLog(@&quot;age is %d&quot;, person.age);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>__block在MRC下有两个作用:</p>
<ol>
<li>允许在block中访问和修改局部变量</li>
<li>禁止block对所引用的对象进行隐式retain操作</li>
</ol>
<p>__block在ARC下的作用:</p>
<ol>
<li>允许在block中访问和修改局部变量</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/15/18-iOS9.0~9.3App Store下载奔溃/" rel="next" title="关于iOS9.0~9.3 App Store下载奔溃问题">
                <i class="fa fa-chevron-left"></i> 关于iOS9.0~9.3 App Store下载奔溃问题
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/09/20/20-scrapy/" rel="prev" title="scrapy 相关使用">
                scrapy 相关使用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">38</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、概述"><span class="nav-number">1.</span> <span class="nav-text">一、概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、Block捕获变量"><span class="nav-number">2.</span> <span class="nav-text">二、Block捕获变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、Block的类型"><span class="nav-number">3.</span> <span class="nav-text">三、Block的类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-block的类型"><span class="nav-number">3.1.</span> <span class="nav-text">1. block的类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-如何确定block的存储位置"><span class="nav-number">3.2.</span> <span class="nav-text">2. 如何确定block的存储位置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-Block不捕获变量"><span class="nav-number">3.2.0.1.</span> <span class="nav-text">1. Block不捕获变量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-Block捕获变量-包括局部变量和全局变量"><span class="nav-number">3.2.0.2.</span> <span class="nav-text">2. Block捕获变量(包括局部变量和全局变量)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Block的copy"><span class="nav-number">3.3.</span> <span class="nav-text">3. Block的copy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-block-修饰"><span class="nav-number">3.4.</span> <span class="nav-text">4. __block 修饰</span></a></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#四、Block循环引用"><span class="nav-number">4.</span> <span class="nav-text">四、Block循环引用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方法"><span class="nav-number">4.1.</span> <span class="nav-text">解决方法:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一-ARC环境下-使用-weak-unsafe-unretained-block"><span class="nav-number">4.1.1.</span> <span class="nav-text">一: ARC环境下: 使用__weak / __unsafe_unretained / __block</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-weak"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">1. __weak</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-unsafe-unretained"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">2. __unsafe_unretained</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-block-（注意避免产生循环引用）"><span class="nav-number">4.1.1.3.</span> <span class="nav-text">3. __block （注意避免产生循环引用）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二-MRC下-使用-block-unsafe-unretained"><span class="nav-number">4.1.2.</span> <span class="nav-text">二: MRC下: 使用__block / __unsafe_unretained</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-unsafe-unretained"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">1. __unsafe_unretained</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-block"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">2. __block</span></a></li></ol></li></ol></li></ol></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("ooQOr7TTg57HoBj7HT3rMBQi-gzGzoHsz", "gVvc3Lp5txd9lBVhetFaDBFs");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
